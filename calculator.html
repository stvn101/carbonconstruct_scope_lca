<!DOCTYPE html>
<html lang="en">
<head>
    <!--Start of Tawk.to Script-->
    <script type="text/javascript">
    var Tawk_API=Tawk_API||{}, Tawk_LoadStart=new Date();
    (function(){
    var s1=document.createElement("script"),s0=document.getElementsByTagName("script")[0];
    s1.async=true;
    s1.src='https://embed.tawk.to/68f6680f559a7e194c8016cf/1j818cvpp';
    s1.charset='UTF-8';
    s1.setAttribute('crossorigin','*');
    s0.parentNode.insertBefore(s1,s0);
    })();
    </script>
    <!--End of Tawk.to Script-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CarbonConstruct - Embodied Carbon Calculator</title>

    <!-- Tailwind CSS for rapid, professional styling -->
    

<script>
// Environment variables injected at build time from Vercel
// NO HARDCODED KEYS - All from environment variables
window.ENV = {
    NEXT_PUBLIC_EC3_API_KEY: '',
    NEXT_PUBLIC_SUPABASE_URL: '',
    NEXT_PUBLIC_SUPABASE_ANON_KEY: '',
    APP_URL: '' || window.location.origin,
    EC3_CLIENT_ID: 'gNyUuor5vOAOiCrRdQ7o209nnMzESTrb4HpGKpqX'
};
console.log('✅ Environment variables loaded from build');
</script>
</head>
<body class="bg-brand-mint">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-brand-navy bg-opacity-95 z-[9999] flex items-center justify-center">
        <div class="text-center max-w-md px-6">
            <!-- Animated Logo -->
            <div class="mb-8">
                <i class="fas fa-leaf text-brand-primary text-6xl animate-pulse"></i>
            </div>

            <!-- Loading Message -->
            <h2 class="text-2xl font-bold text-white mb-4">
                <span id="loading-message">Loading Carbon Calculator...</span>
            </h2>

            <!-- Progress Bar -->
            <div class="w-full bg-brand-steel bg-opacity-30 rounded-full h-3 mb-4 overflow-hidden">
                <div id="loading-progress" class="bg-gradient-to-r from-brand-primary to-brand-forest h-full rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>

            <!-- Progress Percentage -->
            <p class="text-brand-sage-light mb-6">
                <span id="loading-percentage">0</span>% Complete
            </p>

            <!-- Carbon Tips (Rotated) -->
            <div class="bg-brand-forest bg-opacity-20 rounded-lg p-4 text-brand-mint text-sm">
                <i class="fas fa-lightbulb text-brand-primary mr-2"></i>
                <span id="carbon-tip">Loading 54,000+ Australian construction materials...</span>
            </div>
        </div>
    </div>

    <!-- Navigation Header -->
    <nav class="bg-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <i class="fas fa-leaf text-brand-forest text-2xl mr-3"></i>
                    <span class="text-xl font-bold text-brand-navy">CarbonConstruct</span>
                    <span class="ml-3 text-sm text-brand-sage">Embodied Carbon Calculator</span>
                </div>
                <div class="hidden md:flex space-x-6">
                    <a href="dashboard.html" class="text-brand-steel hover:text-brand-forest font-medium">
                        <i class="fas fa-chart-line mr-1"></i>Dashboard
                    </a>
                    <a href="#calculator" class="text-brand-steel hover:text-brand-forest font-medium">Calculator</a>
                    <a href="#lca" class="text-brand-steel hover:text-brand-forest font-medium">LCA</a>
                    <a href="operational-carbon.html" class="text-brand-primary hover:text-brand-primary-dark font-semibold">
                        <i class="fas fa-industry mr-1"></i>Operational
                    </a>
                    <a href="#compliance" class="text-brand-steel hover:text-brand-forest font-medium">Compliance</a>
                    <a href="#saved" class="text-brand-steel hover:text-brand-forest font-medium">Projects</a>
                </div>
                <div class="flex items-center space-x-3">
                    <button id="newProjectBtn" class="bg-brand-forest hover:bg-brand-primary-dark text-white px-4 py-2 rounded-lg font-medium">
                        <i class="fas fa-plus mr-2"></i>New Project
                    </button>
                    <div id="userMenu" class="relative">
                        <button id="userMenuBtn" class="flex items-center space-x-2 text-brand-steel hover:text-brand-forest">
                            <i class="fas fa-user-circle text-2xl"></i>
                        </button>
                        <div id="userDropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg py-2 z-50">
                            <a href="dashboard.html" class="block px-4 py-2 text-brand-steel hover:bg-brand-mint">Dashboard</a>
                            <a href="settings.html" class="block px-4 py-2 text-brand-steel hover:bg-brand-mint">Settings</a>
                            <a href="subscription.html" class="block px-4 py-2 text-brand-steel hover:bg-brand-mint">Subscription</a>
                            <hr class="my-2">
                            <button id="signOutBtn" class="block w-full text-left px-4 py-2 text-red-600 hover:bg-red-50">Sign Out</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main id="main-content" role="main">
    <!-- Hero Section -->
    <section class="bg-gradient-to-r from-brand-forest to-brand-midnight text-white py-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <h1 class="text-4xl font-bold mb-4">Embodied Carbon Calculator</h1>
            <p class="text-xl text-brand-mint mb-6">
                Complete Life Cycle Assessment (LCA) for Australian Construction Projects
            </p>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="bg-white bg-opacity-10 backdrop-blur-sm rounded-lg p-4">
                    <i class="fas fa-check-circle text-2xl mb-2"></i>
                    <h3 class="font-semibold">NCC Compliant</h3>
                    <p class="text-sm text-brand-mint">National Construction Code</p>
                </div>
                <div class="bg-white bg-opacity-10 backdrop-blur-sm rounded-lg p-4">
                    <i class="fas fa-star text-2xl mb-2"></i>
                    <h3 class="font-semibold">NABERS Ready</h3>
                    <p class="text-sm text-brand-mint">Energy & Carbon Rating</p>
                </div>
                <div class="bg-white bg-opacity-10 backdrop-blur-sm rounded-lg p-4">
                    <i class="fas fa-building text-2xl mb-2"></i>
                    <h3 class="font-semibold">GBCA Standards</h3>
                    <p class="text-sm text-brand-mint">Green Star the Gold Standard</p>
                </div>
                <div class="bg-white bg-opacity-10 backdrop-blur-sm rounded-lg p-4">
                    <i class="fas fa-chart-line text-2xl mb-2"></i>
                    <h3 class="font-semibold">Full LCA</h3>
                    <p class="text-sm text-brand-mint">Cradle to Grave Analysis</p>
                </div>
            </div>
        </div>
    </section>

    <!-- NEW: Operational Carbon Tracking Banner -->
    <section class="bg-gradient-to-r from-brand-primary to-brand-forest text-white py-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex flex-col md:flex-row items-center justify-between">
                <div class="mb-4 md:mb-0">
                    <h2 class="text-2xl font-bold mb-2">
                        <i class="fas fa-fire mr-2"></i>
                        NEW: Track Scope 1 & 2 Emissions
                    </h2>
                    <p class="text-brand-mint">
                        Complete operational carbon tracking for site equipment, electricity, transport, waste & more.
                        <strong>Required for TCFD compliance!</strong>
                    </p>
                </div>
                <a href="operational-carbon.html" class="bg-white text-brand-forest hover:bg-brand-mint px-6 py-3 rounded-lg font-bold text-lg whitespace-nowrap">
                    Track Operational Carbon Emissions
                </a>
            </div>
        </div>
    </section>

    <!-- Main Calculator Section -->
    <section id="calculator" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <div class="bg-white rounded-xl shadow-lg p-8 mb-8">
            <h2 class="text-2xl font-bold text-brand-navy mb-6">
                <i class="fas fa-calculator text-brand-forest mr-2"></i>
                Project Details
            </h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                    <label class="block text-sm font-medium text-brand-steel mb-2">Project Name</label>
                    <input type="text" id="projectName" class="w-full px-4 py-2 border border-brand-border rounded-lg focus:ring-2 focus:ring-brand-forest focus:border-transparent" placeholder="e.g., Melbourne Office Tower">
                </div>
                <div>
                    <label class="block text-sm font-medium text-brand-steel mb-2">Project Type</label>
                    <select id="projectType" title="Select project type" class="w-full px-4 py-2 border border-brand-border rounded-lg focus:ring-2 focus:ring-brand-forest focus:border-transparent">
                        <option value="">Select Type</option>
                        <option value="residential">Residential</option>
                        <option value="commercial">Commercial</option>
                        <option value="industrial">Industrial</option>
                        <option value="infrastructure">Infrastructure</option>
                        <option value="mixed-use">Mixed Use</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-brand-steel mb-2">Gross Floor Area (m2)</label>
                    <input type="number" id="gfa" class="w-full px-4 py-2 border border-brand-border rounded-lg focus:ring-2 focus:ring-brand-forest focus:border-transparent" placeholder="e.g., 5000">
                </div>
                <div>
                    <label class="block text-sm font-medium text-brand-steel mb-2">Design Life (years)</label>
                    <input type="number" id="designLife" value="50" placeholder="e.g., 50" class="w-full px-4 py-2 border border-brand-border rounded-lg focus:ring-2 focus:ring-brand-forest focus:border-transparent">
                </div>
            </div>
        </div>

        <!-- AI-Enhanced Calculation Mode Section (v2) -->
        <div class="bg-gradient-to-r from-purple-50 to-blue-50 border-2 border-purple-200 rounded-xl shadow-lg p-8 mb-8">
            <div class="flex items-start justify-between mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-brand-navy mb-2">
                        <i class="fas fa-robot text-purple-600 mr-2"></i>
                        AI-Enhanced Calculation
                        <span class="ml-2 inline-block bg-purple-600 text-white text-xs font-semibold px-2 py-1 rounded-full">BETA</span>
                        <span class="ml-2 inline-block bg-yellow-500 text-white text-xs font-semibold px-2 py-1 rounded-full">PRO</span>
                    </h2>
                    <p class="text-brand-sage">
                        Enable AI-powered analysis for advanced insights, hotspot detection, and automated compliance reporting.
                    </p>
                </div>
                <div class="flex-shrink-0">
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="aiEnhancedMode" class="sr-only peer" value="">
                        <div class="w-14 h-7 bg-gray-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-purple-600"></div>
                        <span class="ml-3 text-sm font-medium text-gray-900">AI Mode</span>
                    </label>
                </div>
            </div>

            <!-- AI Features Grid -->
            <div id="aiFeatures" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6" style="display:none;">
                <div class="bg-white rounded-lg p-4 border border-purple-200">
                    <div class="flex items-center mb-2">
                        <i class="fas fa-brain text-purple-600 text-xl mr-2"></i>
                        <h3 class="font-semibold text-gray-800">Smart Material Matching</h3>
                    </div>
                    <p class="text-sm text-gray-600">Natural language material search with AI recommendations</p>
                </div>
                <div class="bg-white rounded-lg p-4 border border-purple-200">
                    <div class="flex items-center mb-2">
                        <i class="fas fa-fire text-red-600 text-xl mr-2"></i>
                        <h3 class="font-semibold text-gray-800">Hotspot Analysis</h3>
                    </div>
                    <p class="text-sm text-gray-600">Identify top carbon contributors with optimization suggestions</p>
                </div>
                <div class="bg-white rounded-lg p-4 border border-purple-200">
                    <div class="flex items-center mb-2">
                        <i class="fas fa-file-alt text-blue-600 text-xl mr-2"></i>
                        <h3 class="font-semibold text-gray-800">Auto Reports</h3>
                    </div>
                    <p class="text-sm text-gray-600">Generate compliance reports with actionable recommendations</p>
                </div>
            </div>

            <!-- BIM File Upload -->
            <div id="bimUploadSection" class="bg-white rounded-lg p-6 border-2 border-dashed border-purple-300" style="display:none;">
                <div class="text-center">
                    <i class="fas fa-file-upload text-purple-600 text-4xl mb-4"></i>
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">Upload BIM Schedule or CSV</h3>
                    <p class="text-sm text-gray-600 mb-4">
                        AI will automatically parse your material quantities and match to the database
                    </p>
                    <div class="flex items-center justify-center space-x-4">
                        <label class="cursor-pointer bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg font-medium inline-flex items-center">
                            <i class="fas fa-cloud-upload-alt mr-2"></i>
                            Choose File
                            <input type="file" id="bimFileInput" class="hidden" accept=".csv,.xlsx,.ifc,.rvt">
                        </label>
                        <span id="bimFileName" class="text-sm text-gray-500">No file selected</span>
                    </div>
                    <div id="bimParseStatus" class="mt-4 hidden">
                        <div class="flex items-center justify-center text-green-600">
                            <i class="fas fa-check-circle mr-2"></i>
                            <span id="bimParseMessage"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Usage Stats -->
            <div id="aiUsageStats" class="mt-4 p-4 bg-purple-100 rounded-lg" style="display:none;">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <i class="fas fa-chart-bar text-purple-600 mr-2"></i>
                        <span class="text-sm font-medium text-gray-700">AI Usage This Month:</span>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span id="aiUsageCount" class="text-lg font-bold text-purple-600">0 / 50</span>
                        <a href="subscription.html" class="text-xs text-purple-600 hover:underline">Upgrade Plan</a>
                    </div>
                </div>
            </div>

            <!-- Subscription Required Message -->
            <div id="subscriptionRequired" class="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg" style="display:none;">
                <div class="flex items-center">
                    <i class="fas fa-lock text-yellow-600 text-2xl mr-4"></i>
                    <div class="flex-1">
                        <h4 class="font-semibold text-gray-800 mb-1">Pro Subscription Required</h4>
                        <p class="text-sm text-gray-600 mb-2">
                            AI-Enhanced features require a Pro subscription. Upgrade to unlock advanced analysis, automation, and insights.
                        </p>
                        <a href="subscription.html" class="inline-block bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg text-sm font-medium">
                            <i class="fas fa-star mr-1"></i>Upgrade to Pro
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Material Input Section -->
        <div class="bg-white rounded-xl shadow-lg p-8 mb-8">
            <h2 class="text-2xl font-bold text-brand-navy mb-6">
                <i class="fas fa-cubes text-brand-forest mr-2"></i>
                Materials & Quantities
            </h2>

            <div class="mb-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-brand-steel mb-2">Material Category</label>
                        <select id="materialCategory" title="Material Category" class="w-full px-4 py-2 border border-brand-border rounded-lg focus:ring-2 focus:ring-brand-forest focus:border-transparent">
                            <option value="">Select Category</option>
                            <option value="concrete">Concrete</option>
                            <option value="steel">Steel</option>
                            <option value="timber">Timber</option>
                            <option value="masonry">Masonry</option>
                            <option value="insulation">Insulation</option>
                            <option value="glazing">Glazing</option>
                            <option value="finishes">Finishes</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-brand-steel mb-2">Specific Material</label>
                        <select id="materialType" title="Specific Material" class="w-full px-4 py-2 border border-brand-border rounded-lg focus:ring-2 focus:ring-brand-forest focus:border-transparent">
                            <option value="">Select Material</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-brand-steel mb-2">Quantity</label>
                        <input type="number" id="materialQuantity" class="w-full px-4 py-2 border border-brand-border rounded-lg focus:ring-2 focus:ring-brand-forest focus:border-transparent" placeholder="0">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-brand-steel mb-2">Unit</label>
                        <select id="materialUnit" title="Material Unit" class="w-full px-4 py-2 border border-brand-border rounded-lg focus:ring-2 focus:ring-brand-forest focus:border-transparent">
                            <option value="m3">m3│</option>
                            <option value="tonnes">tonnes</option>
                            <option value="m2">m2</option>
                            <option value="kg">kg</option>
                            <option value="units">units</option>
                        </select>
                    </div>
                </div>
                <button id="addMaterialBtn" class="bg-brand-forest hover:bg-brand-primary-dark text-white px-6 py-2 rounded-lg font-medium">
                    <i class="fas fa-plus mr-2"></i>Add Material
                </button>
            </div>

            <!-- Materials List -->
            <div id="materialsList" class="border-t border-brand-border pt-4">
                <h3 class="text-lg font-semibold text-brand-navy mb-4">Added Materials</h3>
                <div id="materialsTable" class="overflow-x-auto">
                    <!-- Materials will be added here dynamically -->
                </div>
            </div>
        </div>
    </section>

    <!-- LCA Section -->
    <section id="lca" class="bg-brand-mint py-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <h2 class="text-2xl font-bold text-brand-navy mb-6">
                    <i class="fas fa-recycle text-brand-forest mr-2"></i>
                    Life Cycle Assessment (LCA)
                </h2>

                <p class="text-brand-sage mb-6">
                    Complete cradle-to-grave analysis following ISO 14040/14044 standards and EN 15978 for construction products.
                </p>

                <!-- LCA Stages Breakdown -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                    <!-- Product Stage (A1-A3) -->
                    <div class="carbon-card bg-blue-50 border-2 border-blue-200 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="font-semibold text-blue-900">Product Stage</h3>
                            <i class="fas fa-industry text-blue-600"></i>
                        </div>
                        <p class="text-sm text-blue-700 mb-2">A1-A3: Manufacturing</p>
                        <p class="text-2xl font-bold text-blue-900" id="lcaA1A3">0</p>
                        <p class="text-sm text-blue-600">kg CO2-e</p>
                    </div>

                    <!-- Construction Stage (A4-A5) -->
                    <div class="carbon-card bg-yellow-50 border-2 border-yellow-200 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="font-semibold text-yellow-900">Construction</h3>
                            <i class="fas fa-truck text-yellow-600"></i>
                        </div>
                        <p class="text-sm text-yellow-700 mb-2">A4-A5: Transport & Build</p>
                        <p class="text-2xl font-bold text-yellow-900" id="lcaA4A5">0</p>
                        <p class="text-sm text-yellow-600">kg CO2-e</p>
                    </div>

                    <!-- Use Stage (B1-B7) -->
                    <div class="carbon-card bg-purple-50 border-2 border-purple-200 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="font-semibold text-purple-900">Use Stage</h3>
                            <i class="fas fa-home text-purple-600"></i>
                        </div>
                        <p class="text-sm text-purple-700 mb-2">B1-B7: Operations & Maint.</p>
                        <p class="text-2xl font-bold text-purple-900" id="lcaB1B7">0</p>
                        <p class="text-sm text-purple-600">kg CO2-e</p>
                    </div>

                    <!-- End of Life (C1-C4) -->
                    <div class="carbon-card bg-red-50 border-2 border-red-200 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="font-semibold text-red-900">End of Life</h3>
                            <i class="fas fa-trash-alt text-red-600"></i>
                        </div>
                        <p class="text-sm text-red-700 mb-2">C1-C4: Demolition & Disposal</p>
                <!-- LCA Chart -->
                <div class="chart-container chart-container-400">
                    <canvas id="lcaChart"></canvas>
                </div>

                <!-- LCA Chart -->
                <div class="chart-container" style="height: 400px;">
                    <canvas id="lcaChart"></canvas>
                </div>
            </div>
        </div>
    </section>

    <!-- Scopes Section -->
    <section id="scopes" class="py-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <h2 class="text-2xl font-bold text-brand-navy mb-6">
                    <i class="fas fa-layer-group text-brand-forest mr-2"></i>
                    GHG Protocol Scopes (1, 2, 3)
                </h2>

                <p class="text-brand-sage mb-6">
                    Greenhouse Gas emissions categorized following the GHG Protocol Corporate Standard for comprehensive reporting.
                </p>

                <!-- Scopes Breakdown -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <!-- Scope 1: Direct Emissions -->
                    <div class="carbon-card bg-brand-mint border-2 border-brand-border rounded-lg p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-brand-midnight">Scope 1</h3>
                            <i class="fas fa-fire text-brand-forest text-2xl"></i>
                        </div>
                        <p class="text-sm text-brand-primary-dark mb-4">Direct emissions from owned or controlled sources</p>
                        <ul class="text-sm text-brand-primary-dark mb-4 space-y-1">
                            <li>ΓÇó On-site fuel combustion</li>
                            <li>ΓÇó Company vehicles</li>
                            <li>ΓÇó Fugitive emissions</li>
                        </ul>
                        <p class="text-3xl font-bold text-brand-midnight" id="scope1Total">0</p>
                        <p class="text-sm text-brand-forest">kg CO2-e</p>
                    </div>

                    <!-- Scope 2: Indirect Energy Emissions -->
                    <div class="carbon-card bg-teal-50 border-2 border-teal-200 rounded-lg p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-teal-900">Scope 2</h3>
                            <i class="fas fa-bolt text-teal-600 text-2xl"></i>
                        </div>
                        <p class="text-sm text-teal-700 mb-4">Indirect emissions from purchased energy</p>
                        <ul class="text-sm text-teal-700 mb-4 space-y-1">
                            <li>ΓÇó Purchased electricity</li>
                            <li>ΓÇó Purchased heating/cooling</li>
                            <li>ΓÇó Purchased steam</li>
                        </ul>
                        <p class="text-3xl font-bold text-teal-900" id="scope2Total">0</p>
                        <p class="text-sm text-teal-600">kg CO2-e</p>
                    </div>

                    <!-- Scope 3: Value Chain Emissions -->
                    <div class="carbon-card bg-indigo-50 border-2 border-indigo-200 rounded-lg p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-indigo-900">Scope 3</h3>
                            <i class="fas fa-globe text-indigo-600 text-2xl"></i>
                        </div>
                        <p class="text-sm text-indigo-700 mb-4">All other indirect emissions in value chain</p>
                        <ul class="text-sm text-indigo-700 mb-4 space-y-1">
                            <li>ΓÇó Material production</li>
                            <li>ΓÇó Transportation</li>
                            <li>ΓÇó Waste & end-of-life</li>
                        </ul>
                <!-- Scopes Chart -->
                <div class="chart-container chart-container-400">
                    <canvas id="scopesChart"></canvas>
                </div>

                <!-- Scopes Chart -->
                <div class="chart-container" style="height: 400px;">
                    <canvas id="scopesChart"></canvas>
                </div>
            </div>
        </div>
    </section>

    <!-- Compliance Section -->
    <section id="compliance" class="bg-brand-mint py-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <h2 class="text-2xl font-bold text-brand-navy mb-6">
                    <i class="fas fa-clipboard-check text-brand-forest mr-2"></i>
                    Australian Compliance Standards
                </h2>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- NCC Compliance -->
                    <div class="border-2 border-brand-border rounded-lg p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-brand-midnight">NCC 2022</h3>
                            <span id="nccStatus" class="px-3 py-1 bg-brand-surface text-brand-steel rounded-full text-sm font-medium">Pending</span>
                        </div>
                        <p class="text-sm text-brand-sage mb-4">National Construction Code Volume One & Two</p>
                        <ul class="text-sm text-brand-steel space-y-2">
                            <li class="flex items-start">
                                <i class="fas fa-check-circle text-brand-forest mt-1 mr-2"></i>
                                <span>Section J - Energy Efficiency</span>
                            </li>
                            <li class="flex items-start">
                                <i class="fas fa-check-circle text-brand-forest mt-1 mr-2"></i>
                                <span>JV3 - Greenhouse & Energy Min Standards</span>
                            </li>
                            <li class="flex items-start">
                                <i class="fas fa-check-circle text-brand-forest mt-1 mr-2"></i>
                                <span>DTS & Performance Solutions</span>
                            </li>
                        </ul>
                        <div class="mt-4 pt-4 border-t border-brand-border">
                            <p class="text-xs text-brand-sage-light">Embodied Energy: <span id="nccEmbodiedEnergy" class="font-semibold">0 MJ/m3</span></p>
                            <p class="text-xs text-brand-sage-light">Carbon Intensity: <span id="nccCarbonIntensity" class="font-semibold">0 kg CO2-e/m┬▓</span></p>
                        </div>
                    </div>

                    <!-- NABERS Compliance -->
                    <div class="border-2 border-brand-border rounded-lg p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-brand-midnight">NABERS</h3>
                            <span id="nabersRating" class="px-3 py-1 bg-brand-surface text-brand-steel rounded-full text-sm font-medium">0Γÿà</span>
                        </div>
                        <p class="text-sm text-brand-sage mb-4">National Australian Built Environment Rating System</p>
                        <ul class="text-sm text-brand-steel space-y-2">
                            <li class="flex items-start">
                                <i class="fas fa-check-circle text-brand-forest mt-1 mr-2"></i>
                                <span>Energy Rating</span>
                            </li>
                            <li class="flex items-start">
                                <i class="fas fa-check-circle text-brand-forest mt-1 mr-2"></i>
                                <span>Carbon Neutral Certification</span>
                            </li>
                            <li class="flex items-start">
                                <i class="fas fa-check-circle text-brand-forest mt-1 mr-2"></i>
                                <span>Whole Building Assessment</span>
                            </li>
                        </ul>
                        <div class="mt-4 pt-4 border-t border-brand-border">
                            <p class="text-xs text-brand-sage-light">Target Rating: <span class="font-semibold">5.0+ Stars</span></p>
                            <p class="text-xs text-brand-sage-light">Benchmark: <span id="nabersBenchmark" class="font-semibold">Loading...</span></p>
                        </div>
                    </div>

                    <!-- GBCA Green Star -->
                    <div class="border-2 border-brand-border rounded-lg p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-brand-midnight">GBCA Green Star</h3>
                            <span id="greenStarRating" class="px-3 py-1 bg-brand-surface text-brand-steel rounded-full text-sm font-medium">0Γÿà</span>
                        </div>
                        <p class="text-sm text-brand-sage mb-4">Green Building Council of Australia</p>
                        <ul class="text-sm text-brand-steel space-y-2">
                            <li class="flex items-start">
                                <i class="fas fa-check-circle text-brand-forest mt-1 mr-2"></i>
                                <span>Materials Category</span>
                            </li>
                            <li class="flex items-start">
                                <i class="fas fa-check-circle text-brand-forest mt-1 mr-2"></i>
                                <span>Life Cycle Impacts</span>
                            </li>
                            <li class="flex items-start">
                                <i class="fas fa-check-circle text-brand-forest mt-1 mr-2"></i>
                                <span>Responsible Materials Sourcing</span>
                            </li>
                        </ul>
                        <div class="mt-4 pt-4 border-brand-border">
                            <p class="text-xs text-brand-sage-light">Target: <span class="font-semibold">4+ Stars (Best Practice)</span></p>
                            <p class="text-xs text-brand-sage-light">Points: <span id="greenStarPoints" class="font-semibold">0/100</span></p>
                        </div>
                    </div>
                </div>

                <!-- Additional Compliance Requirements -->
                <div class="mt-8 pt-8 border-t border-brand-border">
                    <h3 class="text-lg font-semibold text-brand-navy mb-4">Additional Reporting Requirements</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="flex items-start space-x-3">
                            <i class="fas fa-file-alt text-blue-600 mt-1"></i>
                            <div>
                                <h4 class="font-semibold text-brand-navy">Climate-Related Financial Disclosures (TCFD)</h4>
                                <p class="text-sm text-brand-sage">Required for entities from January 2025</p>
                            </div>
                        </div>
                        <div class="flex items-start space-x-3">
                            <i class="fas fa-chart-bar text-blue-600 mt-1"></i>
                            <div>
                                <h4 class="font-semibold text-brand-navy">NGER Act Reporting</h4>
                                <p class="text-sm text-brand-sage">National Greenhouse and Energy Reporting</p>
                            </div>
                        </div>
                        <div class="flex items-start space-x-3">
                            <i class="fas fa-certificate text-blue-600 mt-1"></i>
                            <div>
                                <h4 class="font-semibold text-brand-navy">EPDs (Environmental Product Declarations)</h4>
                                <p class="text-sm text-brand-sage">Third-party verified environmental data</p>
                            </div>
                        </div>
                        <div class="flex items-start space-x-3">
                            <i class="fas fa-leaf text-blue-600 mt-1"></i>
                            <div>
                                <h4 class="font-semibold text-brand-navy">Australian Embodied Carbon Database</h4>
                                <p class="text-sm text-brand-sage">Aligned with national standards</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Reports & Summary Section -->
    <section id="reports" class="py-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-brand-navy">
                        <i class="fas fa-file-contract text-brand-forest mr-2"></i>
                        Project Summary & Reports
                    </h2>
                    <div class="space-x-3">
                        <button id="calculateBtn" class="bg-brand-forest hover:bg-brand-primary-dark text-white px-6 py-2 rounded-lg font-medium">
                            <i class="fas fa-calculator mr-2"></i>Calculate All
                        </button>
                        <button id="saveProjectBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium">
                            <i class="fas fa-save mr-2"></i>Save Project
                        </button>
                        <button id="exportReportBtn" class="bg-brand-midnight hover:bg-brand-forest text-white px-6 py-2 rounded-lg font-medium">
                            <i class="fas fa-download mr-2"></i>Export Report
                        </button>
                    </div>
                </div>

                <!-- Total Emissions Summary -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="bg-gradient-to-br from-brand-primary to-brand-forest text-white rounded-lg p-6">
                        <h3 class="text-sm font-medium mb-2 opacity-90">Total Embodied Carbon</h3>
                        <p class="text-4xl font-bold mb-1" id="totalCarbon">0</p>
                        <p class="text-sm opacity-90">kg CO2-e</p>
                    </div>
                    <div class="bg-gradient-to-br from-blue-500 to-blue-700 text-white rounded-lg p-6">
                        <h3 class="text-sm font-medium mb-2 opacity-90">Carbon Intensity</h3>
                        <p class="text-4xl font-bold mb-1" id="carbonIntensity">0</p>
                        <p class="text-sm opacity-90">kg CO2-e/m┬▓</p>
                    </div>
                    <div class="bg-gradient-to-br from-purple-500 to-purple-700 text-white rounded-lg p-6">
                        <h3 class="text-sm font-medium mb-2 opacity-90">Equivalent Trees</h3>
                        <p class="text-4xl font-bold mb-1" id="treesEquivalent">0</p>
                        <p class="text-sm opacity-90">trees needed for 10 years</p>
                    </div>
                    <div class="bg-gradient-to-br from-brand-primary to-brand-forest text-white rounded-lg p-6">
                        <h3 class="text-sm font-medium mb-2 opacity-90">Car Equivalent</h3>
                <!-- Materials Breakdown Chart -->
                <div class="mb-8">
                    <h3 class="text-lg font-semibold text-brand-navy mb-4">Carbon by Material Category</h3>
                    <div class="chart-container chart-container-400">
                        <canvas id="materialsChart"></canvas>
                    </div>
                </div>
                    <h3 class="text-lg font-semibold text-brand-navy mb-4">Carbon by Material Category</h3>
                    <div class="chart-container" style="height: 400px;">
                        <canvas id="materialsChart"></canvas>
                    </div>
                </div>

                <!-- Benchmarking -->
                <div class="border-t border-brand-border pt-8">
                    <h3 class="text-lg font-semibold text-brand-navy mb-4">Industry Benchmarking</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="text-center p-4 bg-red-50 rounded-lg">
                            <p class="text-sm text-brand-sage mb-2">Industry Average</p>
                            <p class="text-2xl font-bold text-red-700" id="benchmarkAvg">500</p>
                            <p class="text-sm text-brand-sage">kg CO2-e/m┬▓</p>
                        </div>
                        <div class="text-center p-4 bg-yellow-50 rounded-lg">
                            <p class="text-sm text-brand-sage mb-2">Best Practice</p>
                            <p class="text-2xl font-bold text-yellow-700" id="benchmarkBest">350</p>
                            <p class="text-sm text-brand-sage">kg CO2-e/m┬▓</p>
                        </div>
                        <div class="text-center p-4 bg-brand-mint rounded-lg">
                            <p class="text-sm text-brand-sage mb-2">Your Project</p>
                            <p class="text-2xl font-bold text-brand-primary-dark" id="benchmarkYour">0</p>
                            <p class="text-sm text-brand-sage">kg CO2-e/m┬▓</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Saved Projects Section -->
    <section id="saved" class="bg-brand-mint py-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <h2 class="text-2xl font-bold text-brand-navy mb-6">
                    <i class="fas fa-folder-open text-brand-forest mr-2"></i>
                    Saved Projects
                </h2>
                <div id="savedProjectsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Saved projects will be loaded here -->
                </div>
            </div>
        </div>
    </section>
    </main>

    <!-- Footer -->
    <footer class="bg-brand-midnight text-white py-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center">
                <p class="text-lg font-semibold mb-2">CarbonConstruct - Embodied Carbon Calculator</p>
                <p class="text-brand-sage-light text-sm mb-4">
                    Compliant with NCC 2022, NABERS, GBCA Green Star, and TCFD requirements
                </p>
                <p class="text-brand-sage-light text-xs">
                    Built for Australian construction professionals | ISO 14040/14044 | EN 15978 | GHG Protocol
                </p>
            </div>
        </div>
    </footer>

    <!-- JavaScript -->
    <!-- Configuration (load first) -->
    <script src="js/config.js"></script>

    <!-- External libraries -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Authentication -->
    <script src="auth-supabase.js"></script>

    <!-- API Clients -->
    <script src="js/supabase-client.js"></script>

    <!-- Application Scripts -->
    <script src="js/materials-database.js"></script>
    <script src="js/lca-calculator.js"></script>
    <script src="js/scopes-calculator.js"></script>
    <script src="js/compliance.js"></script>
    <script src="js/charts.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/main.js"></script>

    <!-- Agent Integration -->
    <script src="js/agent-orchestrator.js"></script>

    <!-- Materials Loader (Incremental Loading) -->
    <script src="js/materials-loader.js"></script>

    <!-- Chart.js Lazy Loader -->
    <script src="js/chart-loader.js"></script>

    <!-- Loading State Manager -->
    <script>
        // Carbon reduction tips to show during loading
        const CARBON_TIPS = [
            'Concrete accounts for 8% of global CO2 emissions - consider geopolymer alternatives',
            'Recycled steel cuts embodied carbon by 75% compared to virgin steel',
            'Timber sequesters carbon - it can have negative embodied carbon!',
            'Green Star certification requires <15% reduction in embodied carbon',
            'Transportation typically accounts for only 4-5% of total embodied carbon',
            'Cross-Laminated Timber (CLT) is revolutionizing mid-rise construction',
            'Autoclaved Aerated Concrete (AAC) blocks are lighter and more insulating',
            'NABERS 6-star rating requires carbon intensity <250 kg CO2-e/m²',
            'Module D in LCA accounts for recycling benefits at end-of-life',
            'EN 15978 standardizes LCA for buildings across stages A1-D'
        ];

        let currentTipIndex = 0;
        let tipRotationInterval = null;

        // Loading state controller
        const LoadingController = {
            overlay: null,
            progressBar: null,
            progressPercentage: null,
            messageElement: null,
            tipElement: null,

            init() {
                this.overlay = document.getElementById('loading-overlay');
                this.progressBar = document.getElementById('loading-progress');
                this.progressPercentage = document.getElementById('loading-percentage');
                this.messageElement = document.getElementById('loading-message');
                this.tipElement = document.getElementById('carbon-tip');

                // Start rotating tips
                this.startTipRotation();
            },

            updateProgress(percentage, message) {
                if (this.progressBar) {
                    this.progressBar.style.width = `${percentage}%`;
                }
                if (this.progressPercentage) {
                    this.progressPercentage.textContent = Math.round(percentage);
                }
                if (message && this.messageElement) {
                    this.messageElement.textContent = message;
                }
            },

            startTipRotation() {
                // Show first tip immediately
                if (this.tipElement) {
                    this.tipElement.textContent = CARBON_TIPS[0];
                }

                // Rotate tips every 4 seconds
                tipRotationInterval = setInterval(() => {
                    currentTipIndex = (currentTipIndex + 1) % CARBON_TIPS.length;
                    if (this.tipElement) {
                        this.tipElement.style.opacity = '0';
                        setTimeout(() => {
                            this.tipElement.textContent = CARBON_TIPS[currentTipIndex];
                            this.tipElement.style.opacity = '1';
                        }, 300);
                    }
                }, 4000);
            },

            hide() {
                if (tipRotationInterval) {
                    clearInterval(tipRotationInterval);
                }

                if (this.overlay) {
                    this.overlay.style.opacity = '0';
                    this.overlay.style.transition = 'opacity 0.5s ease-out';

                    setTimeout(() => {
                        this.overlay.style.display = 'none';
                        // Ensure main content is visible
                        const mainContent = document.getElementById('main-content');
                        if (mainContent) {
                            mainContent.style.opacity = '1';
                        }
                    }, 500);
                }
            }
        };

        // Initialize loading controller immediately
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => LoadingController.init());
        } else {
            LoadingController.init();
        }

        // Export for use in other scripts
        window.LoadingController = LoadingController;
    </script>

    <!-- AI-Enhanced UI Controls -->
    <script>
        // AI-Enhanced Mode Toggle Handler
        document.addEventListener('DOMContentLoaded', function() {
            const aiToggle = document.getElementById('aiEnhancedMode');
            const aiFeatures = document.getElementById('aiFeatures');
            const bimUploadSection = document.getElementById('bimUploadSection');
            const aiUsageStats = document.getElementById('aiUsageStats');
            const subscriptionRequired = document.getElementById('subscriptionRequired');
            const bimFileInput = document.getElementById('bimFileInput');
            const bimFileName = document.getElementById('bimFileName');
            const bimParseStatus = document.getElementById('bimParseStatus');
            const bimParseMessage = document.getElementById('bimParseMessage');

            // Check user subscription on page load
            checkUserSubscription();

            // Toggle AI features visibility
            aiToggle.addEventListener('change', async function() {
                const isEnabled = this.checked;

                if (isEnabled) {
                    // Check if user has Pro subscription
                    const hasProAccess = await checkProAccess();

                    if (hasProAccess) {
                        aiFeatures.style.display = 'grid';
                        bimUploadSection.style.display = 'block';
                        aiUsageStats.style.display = 'block';
                        subscriptionRequired.style.display = 'none';

                        // Load usage stats
                        loadAIUsageStats();

                        console.log('[AI Mode] Enabled');
                    } else {
                        // Show upgrade message
                        subscriptionRequired.style.display = 'block';
                        aiFeatures.style.display = 'none';
                        bimUploadSection.style.display = 'none';
                        aiUsageStats.style.display = 'none';

                        // Disable toggle
                        setTimeout(() => {
                            this.checked = false;
                        }, 100);

                        console.warn('[AI Mode] Pro subscription required');
                    }
                } else {
                    aiFeatures.style.display = 'none';
                    bimUploadSection.style.display = 'none';
                    aiUsageStats.style.display = 'none';
                    subscriptionRequired.style.display = 'none';

                    console.log('[AI Mode] Disabled');
                }
            });

            // BIM File Upload Handler
            bimFileInput.addEventListener('change', async function(e) {
                const file = e.target.files[0];
                if (!file) return;

                bimFileName.textContent = file.name;
                bimParseStatus.classList.remove('hidden');
                bimParseMessage.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Parsing file with AI...';

                try {
                    const materials = await window.agentOrchestrator.parseBIMFile(file);

                    bimParseMessage.innerHTML = `<i class="fas fa-check-circle mr-2"></i>Successfully parsed ${materials.length} materials`;

                    // Add materials to the calculator
                    materials.forEach(material => {
                        // TODO: Add material to materials list in calculator
                        console.log('[BIM Parser] Material:', material);
                    });

                    // Refresh usage stats
                    loadAIUsageStats();

                } catch (error) {
                    console.error('[BIM Parser] Error:', error);
                    bimParseMessage.innerHTML = `<i class="fas fa-exclamation-triangle mr-2"></i>Failed to parse file: ${error.message}`;
                    bimParseStatus.classList.add('text-red-600');
                    bimParseStatus.classList.remove('text-green-600');
                }
            });

            // Check user subscription status
            async function checkUserSubscription() {
                // TODO: Implement Supabase subscription check
                console.log('[AI Mode] Checking subscription status...');
            }

            // Check if user has Pro access
            async function checkProAccess() {
                try {
                    // Check if Supabase is initialized
                    if (typeof supabase === 'undefined') {
                        console.warn('[AI Mode] Supabase not initialized');
                        return false;
                    }

                    // Get current user
                    const { data: { user } } = await supabase.auth.getUser();
                    if (!user) {
                        console.log('[AI Mode] User not authenticated');
                        return false;
                    }

                    // Query subscriptions table
                    const { data, error } = await supabase
                        .from('subscriptions')
                        .select('tier, status, features')
                        .eq('user_id', user.id)
                        .eq('status', 'active')
                        .single();

                    if (error) {
                        console.error('[AI Mode] Subscription check error:', error);
                        return false;
                    }

                    // Check if features include ai_agents
                    const hasPro = data && (data.tier === 'pro' || data.tier === 'enterprise');
                    const hasFeature = data && data.features?.includes('ai_agents');

                    return hasPro || hasFeature;

                } catch (error) {
                    console.error('[AI Mode] Pro access check failed:', error);
                    return false;
                }
            }

            // Load AI usage statistics
            async function loadAIUsageStats() {
                try {
                    // Get usage count from Supabase
                    if (typeof supabase === 'undefined') return;

                    const { data: { user } } = await supabase.auth.getUser();
                    if (!user) return;

                    // Get this month's usage
                    const startOfMonth = new Date();
                    startOfMonth.setDate(1);
                    startOfMonth.setHours(0, 0, 0, 0);

                    const { count, error } = await supabase
                        .from('agent_usage_log')
                        .select('*', { count: 'exact', head: true })
                        .eq('user_id', user.id)
                        .gte('timestamp', startOfMonth.toISOString())
                        .eq('success', true);

                    if (error) {
                        console.error('[AI Mode] Usage stats error:', error);
                        return;
                    }

                    // Update UI
                    const usageCount = count || 0;
                    const limit = 50; // TODO: Get limit from subscription tier
                    document.getElementById('aiUsageCount').textContent = `${usageCount} / ${limit}`;

                    console.log(`[AI Mode] Usage: ${usageCount}/${limit}`);

                } catch (error) {
                    console.error('[AI Mode] Failed to load usage stats:', error);
                }
            }
        });
    </script>

    <!-- Initialize Database Connections -->
    <script>
        // Initialize Supabase when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🚀 Initializing CarbonConstruct...');

            try {
                // Update loading progress
                if (window.LoadingController) {
                    window.LoadingController.updateProgress(10, 'Connecting to database...');
                }

                const env = window.ENV || {};
                const supabaseUrl = env.SUPABASE_URL || (typeof process !== 'undefined' ? process.env.NEXT_PUBLIC_SUPABASE_URL : '');
                const supabaseKey = env.SUPABASE_ANON_KEY || (typeof process !== 'undefined' ? process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY : '');
                const enableSupabase = typeof env.ENABLE_SUPABASE === 'boolean' ? env.ENABLE_SUPABASE : Boolean(supabaseUrl && supabaseKey);

                // Initialize Supabase
                if (enableSupabase && typeof supabaseClient !== 'undefined') {
                    const supabaseReady = await supabaseClient.initialize({
                        url: supabaseUrl,
                        key: supabaseKey
                    });

                    if (supabaseReady) {
                        console.log('✅ Supabase: Connected to materials database');

                        if (window.LoadingController) {
                            window.LoadingController.updateProgress(20, 'Database connected');
                        }

                        // Test connection
                        const testResult = await supabaseClient.testConnection();
                        if (testResult.connected) {
                            console.log('✅ Supabase: Connection verified');
                        }

                        // Get stats
                        try {
                            const stats = await supabaseClient.getMaterialStats();
                            if (stats) {
                                console.log(`📊 Supabase: ${stats.total} total materials available`);
                            }
                        } catch (e) {
                            console.warn('Could not fetch stats:', e.message);
                        }

                        // Initialize Materials Loader (incremental loading)
                        if (typeof initializeMaterialsLoader !== 'undefined') {
                            const loader = initializeMaterialsLoader(supabaseClient);

                            // Register progress callback
                            loader.onProgress((progress) => {
                                if (window.LoadingController) {
                                    window.LoadingController.updateProgress(
                                        progress.percentage,
                                        progress.message
                                    );
                                }
                            });

                            // Initialize loader (loads essentials immediately, rest in background)
                            await loader.initialize();

                            // Make loader globally available
                            window.materialsLoader = loader;

                            console.log('✅ Materials loader initialized');
                        }
                    } else {
                        console.warn('⚠️  Supabase: Failed to connect, using fallback database');
                        if (window.LoadingController) {
                            window.LoadingController.updateProgress(30, 'Using local materials database');
                        }
                    }
                } else {
                    console.log('⏹️  Supabase: Disabled in configuration');
                    if (window.LoadingController) {
                        window.LoadingController.updateProgress(30, 'Using local materials database');
                    }
                }

                // Wait a moment to ensure everything is rendered
                setTimeout(() => {
                    if (window.LoadingController) {
                        window.LoadingController.updateProgress(100, 'Ready!');
                        setTimeout(() => {
                            window.LoadingController.hide();
                        }, 500);
                    }
                }, 500);

                console.log('✅ CarbonConstruct initialized successfully!');

            } catch (error) {
                console.error('❌ Initialization error:', error);
                // Hide loading overlay even on error
                if (window.LoadingController) {
                    window.LoadingController.updateProgress(100, 'Initialization complete');
                    setTimeout(() => {
                        window.LoadingController.hide();
                    }, 1000);
                }
            }
        });
    </script>

    <!-- Authentication Protection -->
    <script>
        // Protect this page - require authentication
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                if (window.auth && typeof window.auth.protectPage === 'function') {
                    const isAuthorized = await window.auth.protectPage();
                    if (!isAuthorized) {
                        console.log('ΓÜá∩╕Å  User not authenticated, redirecting...');
                        return;
                    }
                    console.log('Γ£à User authenticated');
                } else {
                    console.warn('ΓÜá∩╕Å  Auth system not available, allowing access');
                }
            } catch (error) {
                console.error('Γ¥î Auth check error:', error);
                // Don't block page load on auth errors in development
            }
        });
    </script>

</body>
</html>
