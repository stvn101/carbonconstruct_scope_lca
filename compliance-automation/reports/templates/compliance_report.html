<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compliance Report - {{ project_name }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; background-color: #f8f9fa; }
        .report-container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .header { border-bottom: 3px solid #007bff; padding-bottom: 20px; margin-bottom: 30px; }
        .metric-card { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .finding-card { border-left: 4px solid #ddd; padding: 15px; margin-bottom: 15px; background: #fff; }
        .finding-card.critical { border-left-color: #dc3545; }
        .finding-card.high { border-left-color: #fd7e14; }
        .finding-card.medium { border-left-color: #ffc107; }
        .finding-card.low { border-left-color: #6c757d; }
        .finding-card.pass { border-left-color: #28a745; }
        .evidence-list { font-size: 0.9em; color: #666; }
        .citation { font-style: italic; font-size: 0.85em; color: #555; }
        @media print { .no-print { display: none; } }
    </style>
</head>
<body>
<div class="report-container">

    <!-- Header -->
    <div class="header">
        <h1>üèóÔ∏è Compliance Automation Report</h1>
        <div class="row mt-3">
            <div class="col-md-6">
                <p><strong>Project:</strong> {{ project_name }}</p>
                <p><strong>Project Type:</strong> {{ project_type|capitalize }}</p>
                {% if location %}
                <p><strong>Location:</strong> {{ location.city }}, {{ location.state }}</p>
                {% endif %}
            </div>
            <div class="col-md-6 text-end">
                <p><strong>Report ID:</strong> {{ report_id }}</p>
                <p><strong>Generated:</strong> {{ generated_at|datetime('%d/%m/%Y %H:%M') }}</p>
                <p><strong>Rules Version:</strong> {{ rules_version }}</p>
            </div>
        </div>
    </div>

    <!-- Executive Summary -->
    <section class="mb-5">
        <h2>üìä Executive Summary</h2>

        <div class="row">
            <div class="col-md-3">
                <div class="metric-card text-center">
                    <h3 class="display-4 {% if compliant %}text-success{% else %}text-danger{% endif %}">
                        {{ compliance_status }}
                    </h3>
                    <p class="text-muted">Overall Status</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card text-center">
                    <h3 class="display-4">{{ pass_rate|round(1) }}%</h3>
                    <p class="text-muted">Pass Rate</p>
                    <small>{{ passed_checks }}/{{ total_checks }} checks</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card text-center">
                    <h3 class="display-4">{{ total_embodied_carbon|round(0) }}</h3>
                    <p class="text-muted">Total Carbon (kg CO2-e)</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card text-center">
                    <h3 class="display-4">
                        {% if carbon_intensity %}{{ carbon_intensity|round(1) }}{% else %}N/A{% endif %}
                    </h3>
                    <p class="text-muted">Intensity (kg CO2-e/m¬≤)</p>
                </div>
            </div>
        </div>

        <!-- Severity Summary -->
        <div class="alert alert-{% if critical_count > 0 %}danger{% elif high_count > 0 %}warning{% else %}success{% endif %} mt-3">
            <h5>Issues Summary</h5>
            <ul class="mb-0">
                {% if critical_count > 0 %}
                <li><span class="badge bg-danger">{{ critical_count }} CRITICAL</span> issues require immediate attention</li>
                {% endif %}
                {% if high_count > 0 %}
                <li><span class="badge bg-warning text-dark">{{ high_count }} HIGH</span> severity issues found</li>
                {% endif %}
                {% if medium_count > 0 %}
                <li><span class="badge bg-info">{{ medium_count }} MEDIUM</span> severity issues found</li>
                {% endif %}
                {% if low_count > 0 %}
                <li><span class="badge bg-secondary">{{ low_count }} LOW</span> priority items noted</li>
                {% endif %}
                {% if critical_count == 0 and high_count == 0 %}
                <li>‚úÖ No critical or high-severity issues detected</li>
                {% endif %}
            </ul>
        </div>

        <!-- Data Sources Summary -->
        <div class="row mt-3">
            <div class="col-md-12">
                <h5>Data Sources</h5>
                <div class="d-flex gap-3 flex-wrap">
                    <span class="badge bg-primary">{{ epd_count }} EPDs</span>
                    <span class="badge bg-primary">{{ invoice_count }} Invoices</span>
                    <span class="badge bg-primary">{{ bim_model_count }} BIM Models</span>
                    <span class="badge bg-primary">{{ transport_log_count }} Transport Logs</span>
                    <span class="badge bg-primary">{{ waste_stream_count }} Waste Streams</span>
                    <span class="badge bg-primary">{{ meter_count }} Meters</span>
                </div>
            </div>
        </div>
    </section>

    <!-- Critical Findings -->
    {% if critical_findings %}
    <section class="mb-5">
        <h2 class="text-danger">üö® Critical Findings</h2>
        <p class="text-muted">These issues must be resolved before certification.</p>

        {% for finding in critical_findings %}
        <div class="finding-card critical">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h5>{{ finding.rule_name }}</h5>
                    <p class="mb-2">{{ finding.description }}</p>
                </div>
                <span class="badge bg-danger">CRITICAL</span>
            </div>

            {% if finding.evidence_uris %}
            <div class="evidence-list mt-2">
                <strong>Evidence:</strong>
                <ul class="mb-0">
                    {% for uri in finding.evidence_uris %}
                    <li><code>{{ uri }}</code></li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            <div class="alert alert-light mt-3 mb-0">
                <strong>Remediation:</strong> {{ finding.remediation.action }}<br>
                <strong>Responsible:</strong> {{ finding.remediation.responsible_party }}
                {% if finding.remediation.resources %}
                <br><strong>Resources:</strong>
                <ul class="mb-0">
                    {% for resource in finding.remediation.resources %}
                    <li><a href="{{ resource }}" target="_blank">{{ resource }}</a></li>
                    {% endfor %}
                </ul>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </section>
    {% endif %}

    <!-- High Severity Findings -->
    {% if high_findings %}
    <section class="mb-5">
        <h2 class="text-warning">‚ö†Ô∏è High Severity Findings</h2>
        <p class="text-muted">These issues should be addressed before final reporting.</p>

        {% for finding in high_findings %}
        <div class="finding-card high">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h5>{{ finding.rule_name }}</h5>
                    <p class="mb-2">{{ finding.description }}</p>
                </div>
                <span class="badge bg-warning text-dark">HIGH</span>
            </div>

            {% if finding.evidence_uris %}
            <div class="evidence-list mt-2">
                <strong>Evidence:</strong>
                <ul class="mb-0">
                    {% for uri in finding.evidence_uris %}
                    <li><code>{{ uri }}</code></li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            <div class="alert alert-light mt-3 mb-0">
                <strong>Remediation:</strong> {{ finding.remediation.action }}<br>
                <strong>Responsible:</strong> {{ finding.remediation.responsible_party }}
            </div>
        </div>
        {% endfor %}
    </section>
    {% endif %}

    <!-- Medium Severity Findings -->
    {% if medium_findings %}
    <section class="mb-5">
        <h2 class="text-info">‚ÑπÔ∏è Medium Severity Findings</h2>

        {% for finding in medium_findings %}
        <div class="finding-card medium">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h5>{{ finding.rule_name }}</h5>
                    <p class="mb-2">{{ finding.description }}</p>
                </div>
                <span class="badge bg-info">MEDIUM</span>
            </div>

            {% if finding.remediation %}
            <div class="alert alert-light mt-3 mb-0">
                <strong>Remediation:</strong> {{ finding.remediation.action }}
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </section>
    {% endif %}

    <!-- Passed Checks Summary -->
    <section class="mb-5">
        <h2 class="text-success">‚úÖ Passed Checks ({{ passed_checks }})</h2>
        <div class="accordion" id="passedChecksAccordion">
            {% for rule_id, findings in findings_by_rule.items() %}
                {% set passed_findings_for_rule = findings|selectattr('passed', 'equalto', true)|list %}
                {% if passed_findings_for_rule %}
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ rule_id }}">
                            {{ passed_findings_for_rule[0].rule_name }} ({{ passed_findings_for_rule|length }} checks)
                        </button>
                    </h2>
                    <div id="collapse-{{ rule_id }}" class="accordion-collapse collapse" data-bs-parent="#passedChecksAccordion">
                        <div class="accordion-body">
                            {% for finding in passed_findings_for_rule %}
                            <div class="finding-card pass mb-2">
                                <p class="mb-0">{{ finding.description }}</p>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}
            {% endfor %}
        </div>
    </section>

    <!-- Detailed Findings Table -->
    <section class="mb-5">
        <h2>üìã Detailed Findings</h2>
        <div class="table-responsive">
            <table class="table table-striped table-bordered">
                <thead class="table-dark">
                    <tr>
                        <th>Rule</th>
                        <th>Severity</th>
                        <th>Status</th>
                        <th>Description</th>
                        <th>Entity</th>
                    </tr>
                </thead>
                <tbody>
                    {% for finding in report.findings %}
                    <tr>
                        <td>{{ finding.rule_name }}</td>
                        <td>{{ finding.severity|severity_badge|safe }}</td>
                        <td>{{ finding.passed|status_badge|safe }}</td>
                        <td>{{ finding.description }}</td>
                        <td>{{ finding.entity_type or 'N/A' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </section>

    <!-- Footer -->
    <footer class="mt-5 pt-4 border-top text-center text-muted">
        <p><small>This report was generated automatically by the Carbon Construct Compliance Automation Service.</small></p>
        <p><small>Report ID: {{ report_id }} | Generated: {{ generated_at|datetime('%Y-%m-%d %H:%M:%S UTC') }}</small></p>
    </footer>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
